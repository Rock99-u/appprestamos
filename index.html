<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema de Gestión de Préstamos</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 250px;
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }

        body {
            background-color: #f5f7fb;
            color: #333;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            z-index: 1000;
            overflow-y: auto;
            padding-bottom: 2rem;
        }
        .sidebar-brand { padding: 1.5rem 1rem; font-size: 1.4rem; font-weight: 700; display:flex; align-items:center; }
        .sidebar-brand i { margin-right: 10px; font-size: 1.6rem; }
        .sidebar-menu { margin-top: 1rem; }
        .sidebar-menu ul { list-style: none; padding: 0; }
        .sidebar-menu li { padding: 0.8rem 1.5rem; margin: 0.2rem 0; border-left: 4px solid transparent; cursor: pointer; }
        .sidebar-menu li:hover, .sidebar-menu li.active { background-color: rgba(255,255,255,0.1); border-left: 4px solid white; }
        .sidebar-menu a { color: white; text-decoration: none; display:flex; align-items:center; }

        /* Main content */
        .main-content { margin-left: var(--sidebar-width); padding: 1rem; min-height: 100vh; }

        /* Header */
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            padding: 1rem 1.25rem;
            display:flex; justify-content:space-between; align-items:center;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .search-box { background-color: var(--light); border-radius: 20px; padding: 0.4rem 0.8rem; display:flex; align-items:center; width: 300px; }
        .search-box input { border: none; background: transparent; outline: none; width:100%; padding-left:0.5rem; }

        /* Cards / Tables styles */
        .card { border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border: none; margin-bottom: 1rem; }
        .table th { background-color:#f8f9fa; font-weight:600; }
        .badge-success { background-color: rgba(76,201,240,0.1); color: #4cc9f0; padding: 0.35rem 0.7rem; border-radius: 20px; }
        .badge-warning { background-color: rgba(248,150,30,0.1); color: #f8961e; padding: 0.35rem 0.7rem; border-radius: 20px; }
        .badge-danger { background-color: rgba(247,37,133,0.1); color: #f72585; padding: 0.35rem 0.7rem; border-radius: 20px; }

        .cliente-item { cursor:pointer; display:flex; align-items:center; gap:10px; padding:6px 8px; border-radius:8px; }
        .cliente-item:hover { background:#f0f0f0; }

        @media (max-width: 992px) {
            .sidebar { width:80px; text-align:center; }
            .sidebar-brand span, .sidebar-menu span { display:none; }
            .main-content { margin-left:80px; }
        }
        @media (max-width: 576px) {
            .sidebar { width:0; }
            .main-content { margin-left:0; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-hand-holding-usd"></i>
            <span>PréstamosApp</span>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li class="active" data-section="dashboard"><a><i class="fas fa-home"></i><span> Dashboard</span></a></li>
                <li data-section="caja"><a><i class="fas fa-cash-register"></i><span> Caja</span></a></li>
                <li data-section="clientes"><a><i class="fas fa-users"></i><span> Clientes</span></a></li>
                <li data-section="prestamos"><a><i class="fas fa-hand-holding-usd"></i><span> Préstamos</span></a></li>
                <li data-section="empresa"><a><i class="fas fa-building"></i><span> Empresa</span></a></li>
                <li data-section="reportes"><a><i class="fas fa-chart-bar"></i><span> Reportes</span></a></li>
                <li data-section="backup"><a><i class="fas fa-database"></i><span> Backup</span></a></li>
                <li data-section="configuracion"><a><i class="fas fa-cog"></i><span> Configuración</span></a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input id="searchInput" type="text" placeholder="Buscar...">
            </div>
            <div class="user-profile d-flex align-items-center">
                <img src="https://ui-avatars.com/api/?name=Admin+User&background=random" alt="User" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:10px;">
                <div>
                    <h6 class="mb-0">Admin User</h6>
                    <small class="text-muted">Administrador</small>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="row">
                <div class="col-md-3">
                    <div class="card stat-card p-3 text-center">
                        <i class="fas fa-wallet fa-2x mb-2" style="color:var(--primary)"></i>
                        <h4 id="balanceTotal">GS. 0</h4>
                        <p class="mb-0">Balance Total</p>
                        <span class="badge badge-success">Última actualización</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card p-3 text-center">
                        <i class="fas fa-money-bill-wave fa-2x mb-2" style="color:var(--primary)"></i>
                        <h4 id="ingresosTotales">GS. 0</h4>
                        <p class="mb-0">Ingresos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card p-3 text-center">
                        <i class="fas fa-credit-card fa-2x mb-2" style="color:var(--primary)"></i>
                        <h4 id="egresosTotales">GS. 0</h4>
                        <p class="mb-0">Egresos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card p-3 text-center">
                        <i class="fas fa-hand-holding-usd fa-2x mb-2" style="color:var(--primary)"></i>
                        <h4 id="prestamosActivosCount">0</h4>
                        <p class="mb-0">Préstamos Activos</p>
                    </div>
                </div>
            </div>

            <!-- Préstamos recientes (preview) -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Préstamos Recientes</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoPrestamoModal">Nuevo préstamo</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="tablaPrestamosRecientes">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Monto</th>
                                            <th>Tasa</th>
                                            <th>Plazo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody><!-- cargado por JS --></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clientes -->
        <div id="clientes" class="section">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Gestión de Clientes</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoClienteModal">Nuevo cliente</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaClientes">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Teléfono</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody><!-- cargado por JS --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Préstamos (solo pendientes en esta vista) -->
        <div id="prestamos" class="section">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Préstamos Pendientes de Cobro</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoPrestamoModal">Nuevo préstamo</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaPrestamosPendientes">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Cliente</th>
                                    <th>Monto</th>
                                    <th>Saldo</th>
                                    <th>Interés</th>
                                    <th>Plazo</th>
                                    <th>Fecha Inicio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody><!-- cargado por JS --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Caja -->
        <div id="caja" class="section">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Gestión de Caja</h5>
                    <div>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#registrarCobroModal">Registrar Cobro</button>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="cajaTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="cobros-tab" data-bs-toggle="tab" data-bs-target="#cobros" type="button" role="tab">Cobros Realizados</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pagados-tab" data-bs-toggle="tab" data-bs-target="#pagados" type="button" role="tab">PAGADOS</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="vencidos-tab" data-bs-toggle="tab" data-bs-target="#vencidos" type="button" role="tab">VENCIDOS</button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3" id="cajaTabsContent">
                        <!-- Cobros Realizados -->
                        <div class="tab-pane fade show active" id="cobros" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover" id="tablaCobros">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Préstamo</th>
                                            <th>Monto Cobrado</th>
                                            <th>Descuento</th>
                                            <th>Monto Neto</th>
                                            <th>Forma de Pago</th>
                                        </tr>
                                    </thead>
                                    <tbody><!-- JS --></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Pagados -->
                        <div class="tab-pane fade" id="pagados" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover" id="tablaPagadosCaja">
                                    <thead>
                                        <tr>
                                            <th>#</th><th>Cliente</th><th>Monto Original</th><th>Interés</th><th>Plazo</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody><!-- JS --></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Vencidos -->
                        <div class="tab-pane fade" id="vencidos" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover" id="tablaVencidosCaja">
                                    <thead>
                                        <tr>
                                            <th>#</th><th>Cliente</th><th>Monto Original</th><th>Interés</th><th>Plazo</th><th>Fecha Inicio</th><th>Días Vencido</th><th>Estado</th><th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody><!-- JS --></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Empresa, Reportes, Backup, Configuración (breves) -->
        <div id="empresa" class="section">
            <div class="card"><div class="card-header"><h5>Datos de la Empresa</h5></div><div class="card-body"><p>Configuración de datos empresariales y monedas.</p></div></div>
        </div>
        <div id="reportes" class="section">
            <div class="card"><div class="card-header"><h5>Reportes</h5></div><div class="card-body"><p>Generación de reportes.</p></div></div>
        </div>
        <div id="backup" class="section">
            <div class="card"><div class="card-header"><h5>Backup</h5></div><div class="card-body"><p>Generar y restaurar copias.</p><button class="btn btn-primary">Generar Backup</button></div></div>
        </div>
        <div id="configuracion" class="section">
            <div class="card"><div class="card-header"><h5>Configuración</h5></div><div class="card-body"><p>Usuarios y permisos.</p></div></div>
        </div>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div class="modal fade" id="nuevoClienteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formNuevoCliente" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre completo</label>
                            <input type="text" class="form-control" id="nuevoClienteNombre" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="nuevoClienteEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="nuevoClienteTelefono">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <textarea class="form-control" id="nuevoClienteDireccion" rows="2"></textarea>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo Préstamo -->
    <div class="modal fade" id="nuevoPrestamoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formNuevoPrestamo" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Préstamo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Cliente (selecciona existente o escribe uno nuevo)</label>
                            <input list="clientesList" class="form-control" id="prestamoCliente" required>
                            <datalist id="clientesList"><!-- JS --></datalist>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monto (Gs.)</label>
                            <input type="number" class="form-control" id="prestamoMonto" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tasa (%)</label>
                            <input type="number" class="form-control" id="prestamoTasa" value="12" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Plazo (meses)</label>
                            <input type="number" class="form-control" id="prestamoPlazo" value="12" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="prestamoFechaInicio" required>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear préstamo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Registrar Cobro -->
    <div class="modal fade" id="registrarCobroModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formRegistrarCobro" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Cobro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <input type="hidden" id="cobroPrestamoId">
                        <div class="mb-3">
                            <label class="form-label">Cliente</label>
                            <input type="text" id="cobroCliente" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monto a cobrar (Gs.)</label>
                            <input type="number" id="cobroMonto" class="form-control" required min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descuento (Gs.)</label>
                            <input type="number" id="cobroDescuento" class="form-control" value="0" min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monto Neto (Gs.)</label>
                            <input type="text" id="cobroNeto" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Forma de pago</label>
                            <select id="cobroForma" class="form-select">
                                <option>Efectivo</option>
                                <option>Transferencia</option>
                                <option>Tarjeta</option>
                            </select>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalles Cliente (incluye eliminar) -->
    <div class="modal fade" id="detallesClienteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="clienteModalTitulo" class="modal-title">Detalles del Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img id="clienteModalAvatar" src="" class="rounded-circle" width="100" height="100" alt="">
                        <h4 class="mt-2" id="clienteNombreModal">Nombre</h4>
                        <p class="text-muted" id="clienteEstadoModal">Estado:</p>
                    </div>
                    <p><strong>Email:</strong> <span id="clienteEmailModal"></span></p>
                    <p><strong>Teléfono:</strong> <span id="clienteTelefonoModal"></span></p>
                    <p><strong>Dirección:</strong> <span id="clienteDireccionModal"></span></p>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div>
                        <button type="button" class="btn btn-warning" id="btnEditarCliente">Editar</button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger" id="btnEliminarCliente">Eliminar cliente</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /* ==========================
           Datos de ejemplo (modelo)
           ========================== */
        let clientes = [
            { id: 1, nombre: "Juan Perez", email: "juan@email.com", telefono:"+595 981 234 567", direccion:"Asunción", estado: "Excelente" },
            { id: 2, nombre: "Maria Garcia", email: "maria@email.com", telefono:"+595 982 345 678", direccion:"Luque", estado: "Riesgoso" },
            { id: 3, nombre: "Carlos Lopez", email: "carlos@email.com", telefono:"+595 983 456 789", direccion:"San Lorenzo", estado: "Moroso" }
        ];

        // prestamos tienen id, clienteId, montoOriginal, saldo, interes, plazo, fechaInicio, fechaFin (si aplica), estado: "Activo","Pendiente","Vencido","Pagado"
        let prestamos = [
            { id: 1001, clienteId: 1, clienteNombre: "Juan Perez", montoOriginal: 35000000, saldo: 35000000, interes: 12, plazo: "12 meses", fechaInicio: "2023-06-01", estado: "Activo" },
            { id: 1002, clienteId: 2, clienteNombre: "Maria Garcia", montoOriginal: 24500000, saldo: 24500000, interes: 10, plazo: "6 meses", fechaInicio: "2023-06-15", estado: "Pendiente" },
            { id: 1003, clienteId: 3, clienteNombre: "Carlos Lopez", montoOriginal: 50400000, saldo: 50400000, interes: 15, plazo: "24 meses", fechaInicio: "2023-05-20", estado: "Vencido" },
            { id: 1004, clienteId: 4, clienteNombre: "Roberto Diaz", montoOriginal: 20000000, saldo: 0, interes: 12, plazo: "12 meses", fechaInicio: "2022-01-01", fechaFin:"2023-01-01", estado: "Pagado" },
            { id: 1005, clienteId: 5, clienteNombre: "Ana Martinez", montoOriginal: 15000000, saldo: 0, interes: 10, plazo: "6 meses", fechaInicio: "2022-03-01", fechaFin:"2022-09-01", estado: "Pagado" }
        ];

        // Cobros realizados
        let cobros = [
            { id: 2001, fecha: "2023-08-15", cliente: "Carlos Lopez", prestamoId: 1003, monto: 350000, descuento: 0, neto: 350000, forma: "Efectivo" },
            { id: 2002, fecha: "2023-08-10", cliente: "Ana Martinez", prestamoId: 1005, monto: 420000, descuento: 20000, neto: 400000, forma: "Transferencia" },
            { id: 2003, fecha: "2023-08-05", cliente: "Juan Perez", prestamoId: 1001, monto: 500000, descuento: 30000, neto: 470000, forma: "Tarjeta" }
        ];

        let nextClienteId = 6;
        let nextPrestamoId = 1010;
        let nextCobroId = 3000;

        /* ==========================
           Utilidades
           ========================== */
        const fmtGs = (n) => (n === null || n === undefined) ? "GS. 0" : "GS. " + Number(n).toLocaleString('es-PY');

        function findClienteById(id) {
            return clientes.find(c => c.id === id) || null;
        }

        function findPrestamoById(id) {
            return prestamos.find(p => p.id === id) || null;
        }

        /* ==========================
           Renderizado inicial y funciones de render
           ========================== */

        function activarSidebarListeners() {
            document.querySelectorAll('.sidebar-menu li').forEach(li => {
                li.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-menu li').forEach(x => x.classList.remove('active'));
                    li.classList.add('active');
                    const sec = li.getAttribute('data-section');
                    mostrarSeccion(sec);
                });
            });
        }

        function mostrarSeccion(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const section = document.getElementById(id);
            if(section) section.classList.add('active');

            // Render dinámico según sección
            if(id === 'prestamos') renderPrestamosPendientes();
            if(id === 'caja') { renderCobros(); renderPagadosCaja(); renderVencidosCaja(); }
            if(id === 'clientes') renderClientesTable();
            if(id === 'dashboard') { renderDashboard(); renderPrestamosRecientes(); }
            if(id === 'empresa' || id === 'reportes' || id === 'backup' || id === 'configuracion') { /* no-op */ }
        }

        function renderDashboard() {
            // simples métricas: balance (sum neto cobros), ingresos = sum neto, egresos = 0 (demo)
            const ingresos = cobros.reduce((s,c) => s + (c.neto||0), 0);
            const balance = ingresos; // demo
            document.getElementById('ingresosTotales').textContent = fmtGs(ingresos);
            document.getElementById('balanceTotal').textContent = fmtGs(balance);
            document.getElementById('egresosTotales').textContent = fmtGs(0);
            const activosCount = prestamos.filter(p => p.estado === 'Activo' || p.estado === 'Pendiente').length;
            document.getElementById('prestamosActivosCount').textContent = activosCount;
        }

        function renderPrestamosRecientes() {
            const tbody = document.querySelector('#tablaPrestamosRecientes tbody');
            tbody.innerHTML = '';
            // mostrar últimos 5 por orden de id
            const recientes = prestamos.slice().sort((a,b)=>b.id - a.id).slice(0,5);
            recientes.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(p.clienteNombre)}&background=random" class="rounded-circle me-2" width="30" height="30" alt="">
                            ${p.clienteNombre}
                        </div>
                    </td>
                    <td>${fmtGs(p.montoOriginal)}</td>
                    <td>${p.interes}%</td>
                    <td>${p.plazo}</td>
                    <td>${p.estado === 'Pagado' ? '<span class="badge badge-success">Pagado</span>' : p.estado === 'Vencido' ? '<span class="badge badge-danger">Vencido</span>' : '<span class="badge badge-warning">Activo</span>'}</td>
                    <td>
                        ${p.estado !== 'Pagado' ? `<button class="btn btn-sm btn-outline-primary" onclick="abrirCobrar(${p.id})">Cobrar</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPrestamosPendientes() {
            const tbody = document.querySelector('#tablaPrestamosPendientes tbody');
            tbody.innerHTML = '';
            // Mostrar solo pendientes/activos (no pagados)
            const pendientes = prestamos.filter(p => p.estado === 'Activo' || p.estado === 'Pendiente');
            pendientes.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.clienteNombre}</td>
                    <td>${fmtGs(p.montoOriginal)}</td>
                    <td>${fmtGs(p.saldo)}</td>
                    <td>${p.interes}%</td>
                    <td>${p.plazo}</td>
                    <td>${p.fechaInicio}</td>
                    <td>${p.estado === 'Vencido' ? '<span class="badge badge-danger">VENCIDO</span>' : '<span class="badge badge-success">Activo</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="verPrestamo(${p.id})">Ver</button>
                        <button class="btn btn-sm btn-outline-info" onclick="abrirCronograma(${p.id})">Cronograma</button>
                        <button class="btn btn-sm btn-outline-success" onclick="abrirCobrar(${p.id})">Cobrar</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editarPrestamo(${p.id})">Editar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            renderPrestamosRecientes();
        }

        function renderPagadosCaja() {
            const tbody = document.querySelector('#tablaPagadosCaja tbody');
            tbody.innerHTML = '';
            const pagados = prestamos.filter(p => p.estado === 'Pagado');
            pagados.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.clienteNombre}</td>
                    <td>${fmtGs(p.montoOriginal)}</td>
                    <td>${p.interes}%</td>
                    <td>${p.plazo}</td>
                    <td>${p.fechaInicio || '-'}</td>
                    <td>${p.fechaFin || '-'}</td>
                    <td><span class="badge badge-success">PAGADO</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderVencidosCaja() {
            const tbody = document.querySelector('#tablaVencidosCaja tbody');
            tbody.innerHTML = '';
            const vencidos = prestamos.filter(p => p.estado === 'Vencido');
            vencidos.forEach(p => {
                // Calcular días vencido si tiene fechaInicio (demo simple)
                let diasVencido = '-';
                if(p.fechaInicio) {
                    const inicio = new Date(p.fechaInicio);
                    const hoy = new Date();
                    diasVencido = Math.max(0, Math.floor((hoy - inicio) / (1000*60*60*24)));
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.clienteNombre}</td>
                    <td>${fmtGs(p.montoOriginal)}</td>
                    <td>${p.interes}%</td>
                    <td>${p.plazo}</td>
                    <td>${p.fechaInicio || '-'}</td>
                    <td>${diasVencido}</td>
                    <td><span class="badge badge-danger">VENCIDO</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="contactarCliente(${p.clienteId})">Contactar</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="refinanciarPrestamo(${p.id})">Refinanciar</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="juridico(${p.id})">Jurídico</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderCobros() {
            const tbody = document.querySelector('#tablaCobros tbody');
            tbody.innerHTML = '';
            cobros.forEach((c, idx) => {
                const tr = document.createElement('tr');
                const prestamoLabel = c.prestamoId ? '#' + c.prestamoId : '-';
                tr.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.fecha}</td>
                    <td>${c.cliente}</td>
                    <td>${prestamoLabel}</td>
                    <td>${fmtGs(c.monto)}</td>
                    <td>${fmtGs(c.descuento)}</td>
                    <td>${fmtGs(c.neto)}</td>
                    <td>${c.forma}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderClientesTable() {
            const tbody = document.querySelector('#tablaClientes tbody');
            tbody.innerHTML = '';
            // construir lista y datalist
            const datalist = document.getElementById('clientesList');
            datalist.innerHTML = '';
            clientes.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.id}</td>
                    <td>
                        <div class="d-flex align-items-center cliente-item" data-id="${c.id}">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(c.nombre)}&background=random" class="rounded-circle me-2" width="30" height="30" alt="">
                            ${c.nombre}
                        </div>
                    </td>
                    <td>${c.email || '-'}</td>
                    <td>${c.telefono || '-'}</td>
                    <td><span class="badge ${c.estado === 'Excelente' ? 'badge-success' : c.estado === 'Moroso' ? 'badge-danger' : 'badge-warning'}">${c.estado}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="verCliente(${c.id})">Ver</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editarCliente(${c.id})">Editar</button>
                    </td>
                `;
                tbody.appendChild(tr);

                // datalist option
                const opt = document.createElement('option');
                opt.value = c.nombre;
                datalist.appendChild(opt);
            });

            // add listener to cliente-item for deletion via ficha (abrir modal detalles)
            document.querySelectorAll('.cliente-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    const id = Number(el.getAttribute('data-id'));
                    verCliente(id);
                });
            });
        }

        /* ==========================
           Funcionalidades: clientes
           ========================== */

        // abrir modal detalles de cliente
        let clienteEnModalId = null;
        function verCliente(id) {
            const c = findClienteById(id);
            if(!c) return alert('Cliente no encontrado');
            clienteEnModalId = c.id;
            document.getElementById('clienteModalTitulo').textContent = 'Detalles del Cliente';
            document.getElementById('clienteModalAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(c.nombre)}&background=random`;
            document.getElementById('clienteNombreModal').textContent = c.nombre;
            document.getElementById('clienteEstadoModal').textContent = `Estado: ${c.estado}`;
            document.getElementById('clienteEmailModal').textContent = c.email || '-';
            document.getElementById('clienteTelefonoModal').textContent = c.telefono || '-';
            document.getElementById('clienteDireccionModal').textContent = c.direccion || '-';
            const modal = new bootstrap.Modal(document.getElementById('detallesClienteModal'));
            modal.show();
        }

        document.getElementById('btnEliminarCliente').addEventListener('click', () => {
            if(clienteEnModalId === null) return;
            if(!confirm('¿Eliminar cliente y todos sus préstamos? Esta acción no se puede deshacer.')) return;
            // eliminar prestamos asociados
            prestamos = prestamos.filter(p => p.clienteId !== clienteEnModalId);
            // eliminar cliente
            clientes = clientes.filter(c => c.id !== clienteEnModalId);
            // actualizar tablas
            renderClientesTable();
            renderPrestamosPendientes();
            renderCobros();
            renderPagadosCaja();
            renderVencidosCaja();
            const modalEl = document.getElementById('detallesClienteModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if(modal) modal.hide();
        });

        document.getElementById('btnEditarCliente').addEventListener('click', () => {
            if(clienteEnModalId === null) return;
            // abrir modal nuevo cliente con datos para editar
            const cliente = findClienteById(clienteEnModalId);
            if(!cliente) return;
            document.getElementById('nuevoClienteNombre').value = cliente.nombre;
            document.getElementById('nuevoClienteEmail').value = cliente.email || '';
            document.getElementById('nuevoClienteTelefono').value = cliente.telefono || '';
            document.getElementById('nuevoClienteDireccion').value = cliente.direccion || '';
            // cerrar detalles y abrir nuevo cliente modal
            const detallesModal = bootstrap.Modal.getInstance(document.getElementById('detallesClienteModal'));
            if(detallesModal) detallesModal.hide();
            new bootstrap.Modal(document.getElementById('nuevoClienteModal')).show();

            // on submit replace existing
            const form = document.getElementById('formNuevoCliente');
            form.onsubmit = function(e) {
                e.preventDefault();
                cliente.nombre = document.getElementById('nuevoClienteNombre').value;
                cliente.email = document.getElementById('nuevoClienteEmail').value;
                cliente.telefono = document.getElementById('nuevoClienteTelefono').value;
                cliente.direccion = document.getElementById('nuevoClienteDireccion').value;
                renderClientesTable();
                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('nuevoClienteModal')).hide();
                // restore default onsubmit
                form.onsubmit = crearClienteHandler;
            };
        });

        // crear cliente handler (se asigna inicialmente)
        function crearClienteHandler(e) {
            e.preventDefault();
            const nombre = document.getElementById('nuevoClienteNombre').value.trim();
            if(!nombre) return alert('Nombre requerido');
            const cliente = {
                id: nextClienteId++,
                nombre,
                email: document.getElementById('nuevoClienteEmail').value.trim(),
                telefono: document.getElementById('nuevoClienteTelefono').value.trim(),
                direccion: document.getElementById('nuevoClienteDireccion').value.trim(),
                estado: 'Excelente'
            };
            clientes.push(cliente);
            renderClientesTable();
            document.getElementById('formNuevoCliente').reset();
            bootstrap.Modal.getInstance(document.getElementById('nuevoClienteModal')).hide();
        }

        document.getElementById('formNuevoCliente').addEventListener('submit', crearClienteHandler);

        /* ==========================
           Funcionalidades: préstamos
           ========================== */

        document.getElementById('formNuevoPrestamo').addEventListener('submit', function(e) {
            e.preventDefault();
            const clienteNombre = document.getElementById('prestamoCliente').value.trim();
            if(!clienteNombre) return alert('Cliente requerido');
            // buscar cliente por nombre (no único en producción)
            let cliente = clientes.find(c => c.nombre.toLowerCase() === clienteNombre.toLowerCase());
            if(!cliente) {
                // si no existe, crear cliente rápido
                cliente = { id: nextClienteId++, nombre: clienteNombre, email: '', telefono:'', direccion:'', estado: 'Excelente' };
                clientes.push(cliente);
            }
            const monto = Number(document.getElementById('prestamoMonto').value) || 0;
            const tasa = Number(document.getElementById('prestamoTasa').value) || 0;
            const plazo = document.getElementById('prestamoPlazo').value || '';
            const fechaInicio = document.getElementById('prestamoFechaInicio').value || new Date().toISOString().slice(0,10);

            const prestamo = {
                id: nextPrestamoId++,
                clienteId: cliente.id,
                clienteNombre: cliente.nombre,
                montoOriginal: monto,
                saldo: monto,
                interes: tasa,
                plazo: plazo + (isNaN(Number(plazo)) ? '' : ' meses'),
                fechaInicio,
                estado: 'Activo'
            };
            prestamos.push(prestamo);
            renderPrestamosPendientes();
            renderClientesTable();
            renderDashboard();
            bootstrap.Modal.getInstance(document.getElementById('nuevoPrestamoModal')).hide();
            this.reset();
        });

        function verPrestamo(id) {
            const p = findPrestamoById(id);
            if(!p) return alert('Préstamo no encontrado');
            alert(`Préstamo #${p.id}\nCliente: ${p.clienteNombre}\nMonto: ${fmtGs(p.montoOriginal)}\nSaldo: ${fmtGs(p.saldo)}\nEstado: ${p.estado}`);
        }
        function abrirCronograma(id) { alert('Cronograma (demo) para préstamo #' + id); }
        function editarPrestamo(id) { alert('Editar préstamo (demo) #' + id); }

        /* ==========================
           Funcionalidades: cobros (registro)
           ========================== */

        // abrir modal cobrar con prestamoId (si se usa desde tablas)
        function abrirCobrar(prestamoId) {
            const p = findPrestamoById(prestamoId);
            if(!p) return alert('Préstamo no encontrado');
            document.getElementById('cobroPrestamoId').value = p.id;
            document.getElementById('cobroCliente').value = p.clienteNombre;
            document.getElementById('cobroMonto').value = '';
            document.getElementById('cobroDescuento').value = 0;
            document.getElementById('cobroNeto').value = '';
            new bootstrap.Modal(document.getElementById('registrarCobroModal')).show();
        }

        // actualizar neto cuando cambian monto o descuento
        document.getElementById('cobroMonto').addEventListener('input', actualizarNeto);
        document.getElementById('cobroDescuento').addEventListener('input', actualizarNeto);

        function actualizarNeto() {
            const monto = Number(document.getElementById('cobroMonto').value) || 0;
            const descuento = Number(document.getElementById('cobroDescuento').value) || 0;
            const neto = Math.max(0, monto - descuento);
            document.getElementById('cobroNeto').value = fmtGs(neto);
        }

        // submit cobro
        document.getElementById('formRegistrarCobro').addEventListener('submit', function(e) {
            e.preventDefault();
            const prestamoId = Number(document.getElementById('cobroPrestamoId').value) || null;
            const cliente = document.getElementById('cobroCliente').value || 'N/E';
            const monto = Number(document.getElementById('cobroMonto').value) || 0;
            const descuento = Number(document.getElementById('cobroDescuento').value) || 0;
            const neto = Math.max(0, monto - descuento);
            const forma = document.getElementById('cobroForma').value || 'Efectivo';

            if(monto <= 0) return alert('Ingrese un monto válido');

            const today = new Date().toISOString().slice(0,10);
            const cobro = {
                id: ++nextCobroId,
                fecha: today,
                cliente,
                prestamoId: prestamoId || null,
                monto,
                descuento,
                neto,
                forma
            };
            cobros.unshift(cobro); // añadir arriba
            // actualizar préstamo si existe
            if(prestamoId) {
                const prestamo = findPrestamoById(prestamoId);
                if(prestamo) {
                    prestamo.saldo = Math.max(0, prestamo.saldo - neto);
                    if(prestamo.saldo === 0) {
                        prestamo.estado = 'Pagado';
                        prestamo.fechaFin = today;
                    } else {
                        // si todavía tiene saldo se mantiene activo; si vencido, mantener estado
                        if(prestamo.estado !== 'Vencido') prestamo.estado = 'Activo';
                    }
                }
            }
            // refrescar vistas
            renderCobros();
            renderPrestamosPendientes();
            renderPagadosCaja();
            renderVencidosCaja();
            renderDashboard();
            // cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('registrarCobroModal')).hide();
            this.reset();
        });

        /* ==========================
           Acciones auxiliares
           ========================== */
        function contactarCliente(clienteId) { alert('Contactar cliente id ' + clienteId); }
        function refinanciarPrestamo(id) { alert('Refinanciar préstamo #' + id); }
        function juridico(id) { alert('Derivar a jurídico préstamo #' + id); }

        /* ==========================
           Eventos UI y arranque
           ========================== */

        // buscar (buscador simple sobre clientes y préstamos)
        document.getElementById('searchInput').addEventListener('input', function() {
            const q = this.value.trim().toLowerCase();
            if(!q) {
                // restaurar secciones activas
                renderPrestamosPendientes();
                renderClientesTable();
                renderCobros();
                return;
            }
            // filtrar prestamos pendientes por cliente o id
            const tablaPrestamos = document.querySelector('#tablaPrestamosPendientes tbody');
            tablaPrestamos.innerHTML = '';
            prestamos.filter(p => (p.estado === 'Activo' || p.estado === 'Pendiente')).filter(p => p.clienteNombre.toLowerCase().includes(q) || String(p.id).includes(q)).forEach(p=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${p.id}</td><td>${p.clienteNombre}</td><td>${fmtGs(p.montoOriginal)}</td><td>${fmtGs(p.saldo)}</td><td>${p.interes}%</td><td>${p.plazo}</td><td>${p.fechaInicio}</td><td>${p.estado}</td><td><button class="btn btn-sm btn-outline-primary" onclick="abrirCobrar(${p.id})">Cobrar</button></td>`;
                tablaPrestamos.appendChild(tr);
            });

            // filtrar clientes
            const tablaClientes = document.querySelector('#tablaClientes tbody');
            tablaClientes.innerHTML = '';
            clientes.filter(c => c.nombre.toLowerCase().includes(q) || (c.email || '').toLowerCase().includes(q)).forEach(c=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${c.id}</td><td><div class="d-flex align-items-center cliente-item" data-id="${c.id}"><img src="https://ui-avatars.com/api/?name=${encodeURIComponent(c.nombre)}&background=random" class="rounded-circle me-2" width="30" height="30" alt="">${c.nombre}</div></td><td>${c.email||'-'}</td><td>${c.telefono||'-'}</td><td>${c.estado}</td><td><button class="btn btn-sm btn-outline-primary" onclick="verCliente(${c.id})">Ver</button></td>`;
                tablaClientes.appendChild(tr);
            });

        });

        // arranque
        activarSidebarListeners();
        mostrarSeccion('dashboard');
        renderClientesTable();
        renderPrestamosPendientes();
        renderCobros();
        renderPagadosCaja();
        renderVencidosCaja();
        renderDashboard();

    </script>
</body>
</html>
